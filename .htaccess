############################################
#  基本設定
############################################
DirectoryIndex index.html index.php

############################################
#  GZIP / Brotli 壓縮（mod_deflate）
############################################
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/css
  AddOutputFilterByType DEFLATE application/javascript application/json
  AddOutputFilterByType DEFLATE image/svg+xml
  AddOutputFilterByType DEFLATE font/woff font/woff2
  AddOutputFilterByType DEFLATE text/xml application/xml
</IfModule>

############################################
#  Browser Cache（mod_expires）
############################################
<IfModule mod_expires.c>
  ExpiresActive On
  # 圖片 & 影片
  ExpiresByType image/png  "access plus 1 year"
  ExpiresByType image/jpg  "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/gif  "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/x-icon "access plus 1 year"
  ExpiresByType video/mp4  "access plus 1 year"

  # CSS / JS（我們的自定義CSS檔案也受益）
  ExpiresByType text/css               "access plus 1 month"
  ExpiresByType application/javascript "access plus 1 month"
  
  # 字體檔案
  ExpiresByType font/woff  "access plus 1 year"
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType font/ttf   "access plus 1 year"
  ExpiresByType font/otf   "access plus 1 year"
</IfModule>

############################################
#  安全與 CORS 標頭（mod_headers）
############################################
<IfModule mod_headers.c>
  # 基礎安全
  Header always set X-Content-Type-Options "nosniff"
  Header always set X-Frame-Options "DENY"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  Header always set X-XSS-Protection "1; mode=block"

  # HSTS（兩年，含子網域，可選 preload）
  Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"

  # Keep-Alive 連線優化
  Header always set Connection keep-alive

  # 字體 CORS（支援我們的自定義圖標字體）
  <FilesMatch "\.(ttf|otf|woff|woff2)$">
    Header set Access-Control-Allow-Origin "*"
  </FilesMatch>
  
  # CSS檔案快取優化
  <FilesMatch "\.(css)$">
    Header set Cache-Control "public, max-age=2592000"
  </FilesMatch>
</IfModule>

############################################
#  自訂 404 頁面
############################################
ErrorDocument 404 /404.html

############################################
#  敏感檔案拒絕存取
############################################
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|inc|bak|git|gitignore|ps1)$">
  Require all denied
</FilesMatch>

############################################
#  URL Rewrite 與轉向規則（mod_rewrite）
############################################
<IfModule mod_rewrite.c>
  RewriteEngine On

  # --- 0) Cloudflare 優化功能處理 ---
  #    針對性處理可能造成404的Cloudflare功能
  RewriteCond %{REQUEST_URI} ^/cdn-cgi/(speed|rum|speculation)/ [NC]
  RewriteRule ^ - [R=404,L]

  # --- 1) 一次完成 HTTPS + 去除 www ---
  RewriteCond %{HTTPS} !=on [OR]
  RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
  RewriteRule ^ https://%1%{REQUEST_URI} [L,R=301]

  # --- 2) /index.html → / ---
  RewriteRule ^index\.html$ / [R=301,L]

  # --- 3) 房號重定向規則 （優先處理）---
  RewriteRule ^201/?$ /rooms?room=201 [R=301,L]
  RewriteRule ^203/?$ /rooms?room=203 [R=301,L]
  RewriteRule ^205/?$ /rooms?room=205 [R=301,L]
  RewriteRule ^303/?$ /rooms?room=303 [R=301,L]
  RewriteRule ^302/?$ /rooms?room=302 [R=301,L]
  RewriteRule ^305/?$ /rooms?room=305 [R=301,L]

  # --- 4) 去掉 .html 副檔名（外部 301）---
  RewriteCond %{THE_REQUEST} \s/+(.+?)\.html[\s?] [NC]
  RewriteRule ^ %1 [R=301,L,NE]

  # --- 5) 無副檔名時，內部補 .html ---
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteCond %{REQUEST_FILENAME}.html -f
  RewriteRule ^(.+?)/?$ $1.html [L]
</IfModule>

############################################
#  CSS 優化專用設定
############################################
<IfModule mod_headers.c>
  # 為我們的自定義CSS檔案設定最佳化標頭
  <FilesMatch "custom-icons\.css">
    Header set Cache-Control "public, max-age=2592000"
    Header set X-Content-Type-Options "nosniff"
  </FilesMatch>
  
  # 主要CSS檔案預載入提示
  <FilesMatch "(home|main)\.css">
    Header set Link "</styles/custom-icons.css>; rel=preload; as=style"
  </FilesMatch>
</IfModule>