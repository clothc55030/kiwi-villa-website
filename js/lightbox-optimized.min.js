(function() {
'use strict';
class LightboxOptimized {
constructor() {
this.lightbox = null;
this.currentImages = [];
this.currentIndex = 0;
this.isOpen = false;
this.preloadDistance = 2;
this.init();
}
init() {
this.createLightbox();
this.bindEvents();
this.setupImageTriggers();
}
createLightbox() {
const lightboxHTML = `
<div class="lightbox-modal" role="dialog" aria-modal="true" aria-hidden="true">
<div class="lightbox-overlay"></div>
<div class="lightbox-container">
<button class="lightbox-close" aria-label="關閉圖片預覽">
<i class="fas fa-times"></i>
</button>
<button class="lightbox-prev" aria-label="上一張圖片">
<i class="fas fa-chevron-left"></i>
</button>
<button class="lightbox-next" aria-label="下一張圖片">
<i class="fas fa-chevron-right"></i>
</button>
<div class="lightbox-image-container">
<img class="lightbox-image" src="" alt="">
<div class="lightbox-loading">
<i class="fas fa-spinner fa-spin"></i>
</div>
</div>
<div class="lightbox-caption"></div>
<div class="lightbox-counter"></div>
</div>
</div>
`;
const template = document.createElement('template');
template.innerHTML = lightboxHTML;
this.lightbox = template.content.firstElementChild;
document.body.appendChild(this.lightbox);
this.elements = {
overlay: this.lightbox.querySelector('.lightbox-overlay'),
container: this.lightbox.querySelector('.lightbox-container'),
image: this.lightbox.querySelector('.lightbox-image'),
loading: this.lightbox.querySelector('.lightbox-loading'),
caption: this.lightbox.querySelector('.lightbox-caption'),
counter: this.lightbox.querySelector('.lightbox-counter'),
closeBtn: this.lightbox.querySelector('.lightbox-close'),
prevBtn: this.lightbox.querySelector('.lightbox-prev'),
nextBtn: this.lightbox.querySelector('.lightbox-next')
};
}
bindEvents() {
this.elements.closeBtn.addEventListener('click', () => this.close());
this.elements.overlay.addEventListener('click', () => this.close());
this.elements.prevBtn.addEventListener('click', () => this.navigate(-1));
this.elements.nextBtn.addEventListener('click', () => this.navigate(1));
document.addEventListener('keydown', (e) => {
if (!this.isOpen) return;
switch(e.key) {
case 'Escape':
this.close();
break;
case 'ArrowLeft':
this.navigate(-1);
break;
case 'ArrowRight':
this.navigate(1);
break;
}
});
this.setupTouchEvents();
}
setupTouchEvents() {
let startX = 0;
let startY = 0;
let endX = 0;
let endY = 0;
const minSwipeDistance = 50;
this.elements.container.addEventListener('touchstart', (e) => {
startX = e.touches[0].clientX;
startY = e.touches[0].clientY;
}, { passive: true });
this.elements.container.addEventListener('touchend', (e) => {
endX = e.changedTouches[0].clientX;
endY = e.changedTouches[0].clientY;
const diffX = startX - endX;
const diffY = startY - endY;
if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > minSwipeDistance) {
if (diffX > 0) {
this.navigate(1);
} else {
this.navigate(-1);
}
}
}, { passive: true });
}
setupImageTriggers() {
document.addEventListener('click', (e) => {
const galleryImg = e.target.closest('.room-gallery img');
if (!galleryImg) return;
e.preventDefault();
this.openFromImage(galleryImg);
});
document.addEventListener('keydown', (e) => {
if (e.key === 'Enter' || e.key === ' ') {
const galleryImg = e.target.closest('.room-gallery img');
if (galleryImg) {
e.preventDefault();
this.openFromImage(galleryImg);
}
}
});
}
openFromImage(triggerImage) {
const roomCard = triggerImage.closest('.room-card');
const images = Array.from(roomCard.querySelectorAll('.room-gallery img'));
this.currentImages = images.map(img => ({
src: img.dataset.src || img.src,
alt: img.alt,
element: img
}));
this.currentIndex = images.indexOf(triggerImage);
this.open();
}
open() {
this.isOpen = true;
this.lightbox.setAttribute('aria-hidden', 'false');
this.lightbox.classList.add('active');
document.body.style.overflow = 'hidden';
this.loadImage(this.currentIndex);
this.preloadAdjacentImages();
setTimeout(() => {
this.elements.closeBtn.focus();
}, 100);
}
close() {
this.isOpen = false;
this.lightbox.setAttribute('aria-hidden', 'true');
this.lightbox.classList.remove('active');
document.body.style.overflow = '';
if (this.currentImages[this.currentIndex]?.element) {
this.currentImages[this.currentIndex].element.focus();
}
}
navigate(direction) {
const newIndex = this.currentIndex + direction;
if (newIndex >= 0 && newIndex < this.currentImages.length) {
this.currentIndex = newIndex;
this.loadImage(this.currentIndex);
this.preloadAdjacentImages();
}
}
loadImage(index) {
const imageData = this.currentImages[index];
if (!imageData) return;
this.elements.loading.style.display = 'block';
this.elements.image.style.opacity = '0';
const tempImg = new Image();
tempImg.onload = () => {
this.elements.image.src = tempImg.src;
this.elements.image.alt = imageData.alt;
this.elements.caption.textContent = imageData.alt;
this.elements.counter.textContent = `${index + 1} / ${this.currentImages.length}`;
this.elements.loading.style.display = 'none';
this.elements.image.style.opacity = '1';
this.updateNavigationButtons();
};
tempImg.onerror = () => {
this.elements.loading.style.display = 'none';
this.elements.caption.textContent = '圖片載入失敗';
};
tempImg.src = imageData.src;
}
preloadAdjacentImages() {
for (let i = 1; i <= this.preloadDistance; i++) {
const nextIndex = this.currentIndex + i;
if (nextIndex < this.currentImages.length) {
this.preloadImage(this.currentImages[nextIndex].src);
}
const prevIndex = this.currentIndex - i;
if (prevIndex >= 0) {
this.preloadImage(this.currentImages[prevIndex].src);
}
}
}
preloadImage(src) {
const img = new Image();
img.src = src;
}
updateNavigationButtons() {
this.elements.prevBtn.disabled = this.currentIndex === 0;
this.elements.nextBtn.disabled = this.currentIndex === this.currentImages.length - 1;
this.elements.prevBtn.setAttribute('aria-label',
this.currentIndex > 0 ? '上一張圖片' : '已經是第一張圖片');
this.elements.nextBtn.setAttribute('aria-label',
this.currentIndex < this.currentImages.length - 1 ? '下一張圖片' : '已經是最後一張圖片');
}
}
if (document.readyState === 'loading') {
document.addEventListener('DOMContentLoaded', () => {
new LightboxOptimized();
});
} else {
new LightboxOptimized();
}
window.LightboxOptimized = LightboxOptimized;
})();