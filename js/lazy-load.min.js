(function() {
'use strict';
class LazyImageLoader {
constructor() {
this.imageObserver = null;
this.init();
}
init() {
if ('IntersectionObserver' in window) {
this.imageObserver = new IntersectionObserver((entries, observer) => {
entries.forEach(entry => {
if (entry.isIntersecting) {
this.loadImage(entry.target);
observer.unobserve(entry.target);
}
});
}, {
rootMargin: '200px 0px',
threshold: 0.01
});
this.observeImages();
} else {
this.loadAllImages();
}
}
observeImages() {
const lazyImages = document.querySelectorAll('img.lazyload, img[data-src]');
lazyImages.forEach(img => {
this.imageObserver.observe(img);
});
}
loadImage(img) {
const picture = img.closest('picture');
if (picture) {
const sources = picture.querySelectorAll('source[data-srcset]');
sources.forEach(source => {
source.srcset = source.dataset.srcset;
source.removeAttribute('data-srcset');
});
}
if (img.dataset.src) {
const tempImg = new Image();
tempImg.onload = () => {
img.src = img.dataset.src;
img.removeAttribute('data-src');
img.classList.remove('lazyload');
img.classList.add('lazyloaded');
img.dispatchEvent(new CustomEvent('lazyloaded', {
bubbles: true,
detail: { img }
}));
};
tempImg.src = img.dataset.src;
}
}
loadAllImages() {
const lazyImages = document.querySelectorAll('img.lazyload, img[data-src]');
lazyImages.forEach(img => this.loadImage(img));
}
}
if (document.readyState === 'loading') {
document.addEventListener('DOMContentLoaded', () => {
new LazyImageLoader();
});
} else {
new LazyImageLoader();
}
window.LazyImageLoader = LazyImageLoader;
})();